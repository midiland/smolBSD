
## building an image with nitro

```bash
$ sudo apt install libarchive-tools # for bsdtar
$ mkdir kernels
$ curl -L -o - -s https://nycdn.netbsd.org/pub/NetBSD-daily/netbsd-11/20250916040529Z/amd64/binary/kernel/netbsd-MICROVM.gz | gunzip -c > kernels/netbsd-MICROVM # download a MICROVM kernel
$ make MOUNTRO=y base # create a read-only base image (base-amd64.img)
$ mv base-amd64.img images/frankenbase.img # create image/frankenbase.img
$ mkdir mnt; sudo mount -o loop images/frankenbase.img mnt # mount the image onto ./mnt
$ export VERSION=0.3.0.0.20250907
$ mkdir pkgs
$ curl -L -s -o pkgs/nitro.tggz https://imil.net/NetBSD/nitro-${VERSION}.tgz
$ sudo bsdtar xvpf pkgs/nitro.tgz -C mnt
$ sudo cp mnt/sbin/nitro mnt/sbin/init # replace init with nitro... PHEAR !
$ shasum -a 256 mnt/sbin/init mnt/sbin/nitro # check they are the same
$ sudo umount ./mnt # umount the loop fs
$ ./startnb.sh -k kernels/netbsd-MICROVM -i images/frankenbase.img -a "-v" # TRY it => PANIC ! use C-a C-x to exit
$ sudo mount -o loop images/frankenbase.img mnt # mount again to fix the issue
$ sudo mknod -m 600 mnt/dev/console c 0 0 # we need a console device...
$ sudo mknod -m 666 mnt/dev/null c 2 2    # /dev/null
$ sudo mkdir mnt/etc/nitro # create config/support dir for nitro
$ sudo ln -sf /var/run/nitro.sock mnt/usr/pkg/etc/nitro.sock # link to absolute path, it will work when running from that fs
$ sudo umount mnt
$ ./startnb.sh -k kernels/netbsd-MICROVM -i images/frankenbase.img -a "-v" # \o/ \o/
[   1.0000000] WARNING: system needs entropy for security; see entropy(7)
[   1.0000000] cpu_rng: rdrand/rdseed
[   1.0000000] entropy: ready
[   1.0000000] Copyright (c) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003,
[   1.0000000]     2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013,
[   1.0000000]     2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023,
[   1.0000000]     2024, 2025
[   1.0000000]     The NetBSD Foundation, Inc.  All rights reserved.
[   1.0000000] Copyright (c) 1982, 1986, 1989, 1991, 1993
[   1.0000000]     The Regents of the University of California.  All rights reserved.

[   1.0000000] NetBSD 11.0_BETA (MICROVM) #0: Tue Sep 16 04:05:29 UTC 2025
[   1.0000000] 	mkrepro@mkrepro.NetBSD.org:/usr/src/sys/arch/amd64/compile/MICROVM
[   1.0000000] total memory = 255 MB
[   1.0000000] avail memory = 237 MB
[   1.0000000] timecounter: Timecounters tick every 10.000 msec
[   1.0000000] timecounter: Timecounter "i8254" frequency 1193182 Hz quality 100
[   1.0000030] mainbus0 (root)
[   1.0000030] mainbus0: Intel MP Specification (Version 1.4) (QBOOT    000000000000)
[   1.0000030] cpu0 at mainbus0 apid 0
[   1.0000030] cpu0: Use lfence to serialize rdtsc
[   1.0000030] got tsc frequency from vmware compatible cpuid
[   1.0000030] got lapic frequency from vmware compatible cpuid
[   1.0000030] cpu0: TSC freq CPUID 2112000000 Hz
[   1.0000030] cpu0: 11th Gen Intel(R) Core(TM) i7-1160G7 @ 1.20GHz, id 0x806c1
[   1.0000030] cpu0: node 0, package 0, core 0, smt 0
[   1.0000030] mpbios: bus 0 is type ISA   
[   1.0000030] ioapic0 at mainbus0 apid 2: pa 0xfec00000, version 0x20, 24 pins
[   1.0000030] isa0 at mainbus0
[   1.0000030] com0 at isa0 port 0x3f8-0x3ff irq 4: ns16550a, 16-byte FIFO
[   1.0000030] com0: console
[   1.0000030] allocated pic ioapic0 type edge pin 4 level 8 to cpu0 slot 0 idt entry 129
[   1.0000030] pv0 at mainbus0
[   1.0000030] virtio0 at pv0
[   1.0000030] virtio0: kernel parameters: console=com root=ld0a -v virtio_mmio.device=512@0xfeb00e00:12
[   1.0000030] virtio0: viommio: 512@0xfeb00e00:12
[   1.0000030] virtio0: VirtIO-MMIO-v2
[   1.0000030] virtio0: block device (id 2, rev. 0x01)
[   1.0000030] ld0 at virtio0: features: 0x110002e54<V1,INDIRECT_DESC,DISCARD,CONFIG_WCE,TOPOLOGY,FLUSH,BLK_SIZE,GEOMETRY,SEG_MAX>
[   1.0000030] ld0: Unknown SIZE_MAX, assuming 65536
[   1.0000030] ld0: max 254 segs of max 65536 bytes
[   1.0000030] virtio0: allocated 4227072 byte for virtqueue 0 for I/O request, size 1024
[   1.0000030] virtio0: using 4194304 byte (262144 entries) indirect descriptors
[   1.0000030] allocated pic ioapic0 type level pin 12 level 6 to cpu0 slot 1 idt entry 96
[   1.0000030] virtio0: interrupting on -1
[   1.0000030] ld0: 512 MB, 1040 cyl, 16 head, 63 sec, 512 bytes/sect x 1048576 sectors
[   1.0000030] virtio1 at pv0
[   1.0000030] timecounter: Timecounter "lapic" frequency 1000000000 Hz quality -100
[   1.0000030] timecounter: Timecounter "clockinterrupt" frequency 100 Hz quality 0
[   1.0000030] timecounter: Timecounter "TSC" frequency 2112000000 Hz quality 3000
[   1.0491942] boot device: ld0
[   1.0491942] root on ld0a dumps on ld0b
[   1.0491942] root file system type: ext2fs
[   1.0491942] kern.module.path=/stand/amd64/11.0/modules
[   1.0528279] kernel boot time: 100ms
- nitro: booting
```
\o/ it works \o/ See you next week :wink:
